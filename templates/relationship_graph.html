{% extends "base.html" %}

{% block title %}Relationship Graph - Personal CRM{% endblock %}

{% block extra_css %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>
#relationshipGraph {
    width: 100%;
    height: 700px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: #f8f9fa;
}

.graph-controls {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.legend-item {
    display: inline-block;
    margin-right: 20px;
    padding: 5px 10px;
    background: #e9ecef;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="bi bi-diagram-3-fill text-warning"></i> Relationship Network Graph</h1>
            <p class="text-muted">Visual representation of your social connections</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5><i class="bi bi-people-fill text-primary"></i> Total People</h5>
                    <h2>{{ people_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5><i class="bi bi-arrow-left-right text-warning"></i> Total Relationships</h5>
                    <h2>{{ relationships_count }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph Controls -->
    <div class="graph-controls">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-sm btn-primary" onclick="network.fit()">
                    <i class="bi bi-arrows-fullscreen"></i> Fit View
                </button>
                <button class="btn btn-sm btn-secondary" onclick="network.stabilize()">
                    <i class="bi bi-arrow-clockwise"></i> Reorganize
                </button>
            </div>
            <div class="legend">
                <span class="legend-item"><i class="bi bi-circle-fill text-primary"></i> Person</span>
                <span class="legend-item"><i class="bi bi-arrow-right text-warning"></i> Relationship</span>
            </div>
        </div>
    </div>

    <!-- Graph Container -->
    <div id="relationshipGraph"></div>

    {% if people_count == 0 %}
    <div class="alert alert-info mt-4 text-center">
        <i class="bi bi-info-circle fs-1"></i>
        <h4 class="mt-3">No people added yet</h4>
        <p>Add people and their relationships to see the network graph.</p>
        <a href="{{ url_for('person_add') }}" class="btn btn-primary">
            <i class="bi bi-person-plus"></i> Add First Person
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    // Nodes and edges data from Flask
    const nodes = new vis.DataSet({{ nodes|tojson|safe }});
    const edges = new vis.DataSet({{ edges|tojson|safe }});

    // Graph container
    const container = document.getElementById('relationshipGraph');

    // Graph data
    const data = {
        nodes: nodes,
        edges: edges
    };

    // Configuration options
    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {
                size: 14,
                face: 'Arial'
            },
            borderWidth: 2,
            color: {
                border: '#2B7CE9',
                background: '#97C2FC',
                highlight: {
                    border: '#FFA500',
                    background: '#FFD700'
                }
            }
        },
        edges: {
            width: 2,
            color: {
                color: '#848484',
                highlight: '#FFA500'
            },
            arrows: {
                to: {
                    enabled: true,
                    scaleFactor: 0.5
                }
            },
            font: {
                size: 12,
                align: 'middle'
            },
            smooth: {
                type: 'continuous'
            }
        },
        physics: {
            enabled: true,
            stabilization: {
                iterations: 200
            },
            barnesHut: {
                gravitationalConstant: -8000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            navigationButtons: true,
            keyboard: true
        }
    };

    // Initialize network
    const network = new vis.Network(container, data, options);

    // Click event
    network.on("click", function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            window.location.href = `/people/${nodeId}`;
        }
    });

    // Hover effect
    network.on("hoverNode", function() {
        container.style.cursor = 'pointer';
    });

    network.on("blurNode", function() {
        container.style.cursor = 'default';
    });

    console.log('Graph initialized with', nodes.length, 'nodes and', edges.length, 'edges');
</script>
{% endblock %}
